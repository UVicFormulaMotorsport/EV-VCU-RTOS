\hypertarget{motor__controller_8c}{}\doxysection{Core/\+Src/motor\+\_\+controller.c File Reference}
\label{motor__controller_8c}\index{Core/Src/motor\_controller.c@{Core/Src/motor\_controller.c}}
{\ttfamily \#include \char`\"{}motor\+\_\+controller.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}can.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}cmsis\+\_\+os.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}uvfr\+\_\+utils.\+h\char`\"{}}\newline
{\ttfamily \#include $<$stdlib.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include $<$stdio.\+h$>$}\newline
\doxysubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
uint16\+\_\+t \mbox{\hyperlink{motor__controller_8c_ad9944bce211ed6594929c3acf72e3881}{Motor\+Controller\+Spin\+Test}} (float T\+\_\+filtered)
\begin{DoxyCompactList}\small\item\em Sends a direct torque command to the motor controller. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{motor__controller_8c_af6b3a4911f1bdac54d84b4dcc7b7ec4a}{M\+C\+\_\+\+Request\+\_\+\+Data}} (uint8\+\_\+t Reg\+ID)
\begin{DoxyCompactList}\small\item\em Sends a C\+AN request to retrieve a specific register from the motor controller. \end{DoxyCompactList}\item 
\mbox{\hyperlink{can_8h_aef3770e45bbacbf527fd93dd80eea9b9}{uv\+\_\+status}} \mbox{\hyperlink{motor__controller_8c_a37f4a694fab82b650c96c13fe4894143}{M\+C\+\_\+\+Set\+\_\+\+Param}} (uint8\+\_\+t Reg\+ID, uint16\+\_\+t d)
\item 
void \mbox{\hyperlink{motor__controller_8c_a98ef1edcc51198faf53767e8d92ce4c9}{Parse\+\_\+\+Bamocar\+\_\+\+Response}} (\mbox{\hyperlink{structuv___c_a_n__msg}{uv\+\_\+\+C\+A\+N\+\_\+msg}} $\ast$msg)
\begin{DoxyCompactList}\small\item\em Parses a 32-\/bit value from a C\+AN message in little-\/endian format. \end{DoxyCompactList}\item 
static void \mbox{\hyperlink{motor__controller_8c_aa2fe2c9102e9f2ab65ab4a9d5557f497}{Motor\+Controller\+Error\+Handler\+\_\+16bit\+LE}} (uint8\+\_\+t $\ast$data, uint8\+\_\+t length)
\begin{DoxyCompactList}\small\item\em Helper function to process a 16-\/bit error/warning field (little-\/endian). \end{DoxyCompactList}\item 
void \mbox{\hyperlink{motor__controller_8c_aaff68bb563bf4ad56841a5a5020cbadc}{Process\+Motor\+Controller\+Response}} (\mbox{\hyperlink{structuv___c_a_n__msg}{uv\+\_\+\+C\+A\+N\+\_\+msg}} $\ast$msg)
\begin{DoxyCompactList}\small\item\em Processes a motor controller response received via C\+AN. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{motor__controller_8c_aed1407e1e0fd59dc7c5e5d6db671f0ab}{M\+C\+\_\+\+Startup}} (void $\ast$args)
\begin{DoxyCompactList}\small\item\em Initializes the motor controller. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{structmotor__controller__settings}{motor\+\_\+controller\+\_\+settings}} \mbox{\hyperlink{motor__controller_8c_afb41a96439ba6d63dcc64f257c43a1d2}{mc\+\_\+default\+\_\+settings}}
\end{DoxyCompactItemize}


\doxysubsection{Function Documentation}
\mbox{\Hypertarget{motor__controller_8c_af6b3a4911f1bdac54d84b4dcc7b7ec4a}\label{motor__controller_8c_af6b3a4911f1bdac54d84b4dcc7b7ec4a}} 
\index{motor\_controller.c@{motor\_controller.c}!MC\_Request\_Data@{MC\_Request\_Data}}
\index{MC\_Request\_Data@{MC\_Request\_Data}!motor\_controller.c@{motor\_controller.c}}
\doxysubsubsection{\texorpdfstring{MC\_Request\_Data()}{MC\_Request\_Data()}}
{\footnotesize\ttfamily void M\+C\+\_\+\+Request\+\_\+\+Data (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{Reg\+ID }\end{DoxyParamCaption})}



Sends a C\+AN request to retrieve a specific register from the motor controller. 

The request message is formatted as\+: \mbox{[}0x3D, Reg\+ID, 0\mbox{]}, which should trigger an immediate reply. 

Definition at line 63 of file motor\+\_\+controller.\+c.



References motor\+\_\+controller\+\_\+settings\+::can\+\_\+id\+\_\+tx, uv\+\_\+\+C\+A\+N\+\_\+msg\+::data, uv\+\_\+\+C\+A\+N\+\_\+msg\+::dlc, uv\+\_\+\+C\+A\+N\+\_\+msg\+::flags, mc\+\_\+default\+\_\+settings, uv\+\_\+\+C\+A\+N\+\_\+msg\+::msg\+\_\+id, U\+V\+\_\+\+OK, and uv\+Send\+Can\+M\+S\+G().



Referenced by M\+C\+\_\+\+Startup().

\mbox{\Hypertarget{motor__controller_8c_a37f4a694fab82b650c96c13fe4894143}\label{motor__controller_8c_a37f4a694fab82b650c96c13fe4894143}} 
\index{motor\_controller.c@{motor\_controller.c}!MC\_Set\_Param@{MC\_Set\_Param}}
\index{MC\_Set\_Param@{MC\_Set\_Param}!motor\_controller.c@{motor\_controller.c}}
\doxysubsubsection{\texorpdfstring{MC\_Set\_Param()}{MC\_Set\_Param()}}
{\footnotesize\ttfamily \mbox{\hyperlink{can_8h_aef3770e45bbacbf527fd93dd80eea9b9}{uv\+\_\+status}} M\+C\+\_\+\+Set\+\_\+\+Param (\begin{DoxyParamCaption}\item[{uint8\+\_\+t}]{Reg\+ID,  }\item[{uint16\+\_\+t}]{d }\end{DoxyParamCaption})}



Definition at line 80 of file motor\+\_\+controller.\+c.



References motor\+\_\+controller\+\_\+settings\+::can\+\_\+id\+\_\+tx, uv\+\_\+\+C\+A\+N\+\_\+msg\+::data, uv\+\_\+\+C\+A\+N\+\_\+msg\+::dlc, mc\+\_\+default\+\_\+settings, uv\+\_\+\+C\+A\+N\+\_\+msg\+::msg\+\_\+id, U\+V\+\_\+\+E\+R\+R\+OR, U\+V\+\_\+\+OK, and uv\+Send\+Can\+M\+S\+G().



Referenced by M\+C\+\_\+\+Startup().

\mbox{\Hypertarget{motor__controller_8c_aed1407e1e0fd59dc7c5e5d6db671f0ab}\label{motor__controller_8c_aed1407e1e0fd59dc7c5e5d6db671f0ab}} 
\index{motor\_controller.c@{motor\_controller.c}!MC\_Startup@{MC\_Startup}}
\index{MC\_Startup@{MC\_Startup}!motor\_controller.c@{motor\_controller.c}}
\doxysubsubsection{\texorpdfstring{MC\_Startup()}{MC\_Startup()}}
{\footnotesize\ttfamily void M\+C\+\_\+\+Startup (\begin{DoxyParamCaption}\item[{void $\ast$}]{args }\end{DoxyParamCaption})}



Initializes the motor controller. 

This routine performs the following steps\+:
\begin{DoxyEnumerate}
\item Requests the serial number and firmware version.
\item Sends a nominal torque command (spin test).
\item Requests error/warning data.
\item Suspends itself after successful initialization. 
\end{DoxyEnumerate}

Definition at line 278 of file motor\+\_\+controller.\+c.



References uv\+\_\+init\+\_\+task\+\_\+response\+::device, F\+I\+R\+M\+W\+A\+R\+E\+\_\+\+V\+E\+R\+S\+I\+O\+N\+\_\+\+R\+E\+G\+I\+S\+T\+ER, uv\+\_\+init\+\_\+task\+\_\+args\+::init\+\_\+info\+\_\+queue, insert\+C\+A\+N\+Message\+Handler(), mc\+\_\+default\+\_\+settings, M\+C\+\_\+\+Request\+\_\+\+Data(), M\+C\+\_\+\+Set\+\_\+\+Param(), M\+O\+T\+O\+R\+\_\+\+C\+O\+N\+T\+R\+O\+L\+L\+ER, motor\+\_\+controller\+\_\+errors\+\_\+warnings, Motor\+Controller\+Spin\+Test(), Parse\+\_\+\+Bamocar\+\_\+\+Response(), motor\+\_\+controller\+\_\+settings\+::proportional\+\_\+gain, S\+E\+R\+I\+A\+L\+\_\+\+N\+U\+M\+B\+E\+R\+\_\+\+R\+E\+G\+I\+S\+T\+ER, uv\+\_\+init\+\_\+task\+\_\+response\+::status, and U\+V\+\_\+\+OK.



Referenced by uv\+Init().

\mbox{\Hypertarget{motor__controller_8c_aa2fe2c9102e9f2ab65ab4a9d5557f497}\label{motor__controller_8c_aa2fe2c9102e9f2ab65ab4a9d5557f497}} 
\index{motor\_controller.c@{motor\_controller.c}!MotorControllerErrorHandler\_16bitLE@{MotorControllerErrorHandler\_16bitLE}}
\index{MotorControllerErrorHandler\_16bitLE@{MotorControllerErrorHandler\_16bitLE}!motor\_controller.c@{motor\_controller.c}}
\doxysubsubsection{\texorpdfstring{MotorControllerErrorHandler\_16bitLE()}{MotorControllerErrorHandler\_16bitLE()}}
{\footnotesize\ttfamily static void Motor\+Controller\+Error\+Handler\+\_\+16bit\+LE (\begin{DoxyParamCaption}\item[{uint8\+\_\+t $\ast$}]{data,  }\item[{uint8\+\_\+t}]{length }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [static]}}



Helper function to process a 16-\/bit error/warning field (little-\/endian). 

It expects the error data in 2 bytes where\+: data\mbox{[}0\mbox{]} = L\+SB, data\mbox{[}1\mbox{]} = M\+SB. It checks the error flags and calls uv\+Panic for critical errors. 

Definition at line 146 of file motor\+\_\+controller.\+c.



References A\+C\+\_\+current\+\_\+offset\+\_\+fault, bleed\+\_\+resistor\+\_\+overload, C\+A\+N\+\_\+timeout\+\_\+error, critical\+\_\+\+A\+C\+\_\+current, ecode\+\_\+timeout\+\_\+error, eprom\+\_\+read\+\_\+error, feedback\+\_\+signal\+\_\+error, hardware\+\_\+fault, I\+G\+B\+T\+\_\+temp\+\_\+max\+\_\+limit, internal\+\_\+hardware\+\_\+voltage\+\_\+problem, mains\+\_\+voltage\+\_\+max\+\_\+limit, mains\+\_\+voltage\+\_\+min\+\_\+limit, motor\+\_\+temp\+\_\+max\+\_\+limit, race\+\_\+away\+\_\+detected, rotate\+\_\+field\+\_\+enable\+\_\+not\+\_\+present\+\_\+run, and watchdog\+\_\+reset.



Referenced by Process\+Motor\+Controller\+Response().

\mbox{\Hypertarget{motor__controller_8c_ad9944bce211ed6594929c3acf72e3881}\label{motor__controller_8c_ad9944bce211ed6594929c3acf72e3881}} 
\index{motor\_controller.c@{motor\_controller.c}!MotorControllerSpinTest@{MotorControllerSpinTest}}
\index{MotorControllerSpinTest@{MotorControllerSpinTest}!motor\_controller.c@{motor\_controller.c}}
\doxysubsubsection{\texorpdfstring{MotorControllerSpinTest()}{MotorControllerSpinTest()}}
{\footnotesize\ttfamily uint16\+\_\+t Motor\+Controller\+Spin\+Test (\begin{DoxyParamCaption}\item[{float}]{T\+\_\+filtered }\end{DoxyParamCaption})}



Sends a direct torque command to the motor controller. 

This function accepts a float for the desired torque (T\+\_\+filtered), clamps it between 0 and 100, converts it to a 16-\/bit integer, and then sends it over C\+AN using uv\+Send\+Can\+M\+SG. 

Definition at line 30 of file motor\+\_\+controller.\+c.



References motor\+\_\+controller\+\_\+settings\+::can\+\_\+id\+\_\+tx, uv\+\_\+\+C\+A\+N\+\_\+msg\+::data, uv\+\_\+\+C\+A\+N\+\_\+msg\+::dlc, uv\+\_\+\+C\+A\+N\+\_\+msg\+::flags, mc\+\_\+default\+\_\+settings, uv\+\_\+\+C\+A\+N\+\_\+msg\+::msg\+\_\+id, N\+\_\+set, U\+V\+\_\+\+OK, and uv\+Send\+Can\+M\+S\+G().



Referenced by M\+C\+\_\+\+Startup(), and send\+Torque\+To\+Motor\+Controller().

\mbox{\Hypertarget{motor__controller_8c_a98ef1edcc51198faf53767e8d92ce4c9}\label{motor__controller_8c_a98ef1edcc51198faf53767e8d92ce4c9}} 
\index{motor\_controller.c@{motor\_controller.c}!Parse\_Bamocar\_Response@{Parse\_Bamocar\_Response}}
\index{Parse\_Bamocar\_Response@{Parse\_Bamocar\_Response}!motor\_controller.c@{motor\_controller.c}}
\doxysubsubsection{\texorpdfstring{Parse\_Bamocar\_Response()}{Parse\_Bamocar\_Response()}}
{\footnotesize\ttfamily void Parse\+\_\+\+Bamocar\+\_\+\+Response (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structuv___c_a_n__msg}{uv\+\_\+\+C\+A\+N\+\_\+msg}} $\ast$}]{msg }\end{DoxyParamCaption})}



Parses a 32-\/bit value from a C\+AN message in little-\/endian format. 

This example assumes that the data bytes are stored as\+: data\mbox{[}0\mbox{]} = L\+SB, data\mbox{[}3\mbox{]} = M\+SB. 

Definition at line 104 of file motor\+\_\+controller.\+c.



References uv\+\_\+\+C\+A\+N\+\_\+msg\+::data, deserialize\+Small\+E16, uv\+\_\+\+C\+A\+N\+\_\+msg\+::dlc, mc\+\_\+default\+\_\+settings, and motor\+\_\+controller\+\_\+settings\+::proportional\+\_\+gain.



Referenced by M\+C\+\_\+\+Startup().

\mbox{\Hypertarget{motor__controller_8c_aaff68bb563bf4ad56841a5a5020cbadc}\label{motor__controller_8c_aaff68bb563bf4ad56841a5a5020cbadc}} 
\index{motor\_controller.c@{motor\_controller.c}!ProcessMotorControllerResponse@{ProcessMotorControllerResponse}}
\index{ProcessMotorControllerResponse@{ProcessMotorControllerResponse}!motor\_controller.c@{motor\_controller.c}}
\doxysubsubsection{\texorpdfstring{ProcessMotorControllerResponse()}{ProcessMotorControllerResponse()}}
{\footnotesize\ttfamily void Process\+Motor\+Controller\+Response (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structuv___c_a_n__msg}{uv\+\_\+\+C\+A\+N\+\_\+msg}} $\ast$}]{msg }\end{DoxyParamCaption})}



Processes a motor controller response received via C\+AN. 

This function examines the first byte as the register ID and then processes the rest of the message using little-\/endian parsing. For error/warning responses (for example, when reg\+\_\+id equals motor\+\_\+controller\+\_\+errors\+\_\+warnings), it calls the error handler. 

Definition at line 211 of file motor\+\_\+controller.\+c.



References C\+U\+R\+R\+E\+N\+T\+\_\+\+A\+C\+T\+U\+AL, uv\+\_\+\+C\+A\+N\+\_\+msg\+::data, uv\+\_\+\+C\+A\+N\+\_\+msg\+::dlc, L\+O\+G\+I\+M\+A\+P\+\_\+\+E\+R\+R\+O\+RS, L\+O\+G\+I\+M\+A\+P\+\_\+\+IO, motor\+\_\+controller\+\_\+errors\+\_\+warnings, Motor\+Controller\+Error\+Handler\+\_\+16bit\+L\+E(), N\+\_\+actual, and P\+O\+S\+\_\+\+A\+C\+T\+U\+AL.



\doxysubsection{Variable Documentation}
\mbox{\Hypertarget{motor__controller_8c_afb41a96439ba6d63dcc64f257c43a1d2}\label{motor__controller_8c_afb41a96439ba6d63dcc64f257c43a1d2}} 
\index{motor\_controller.c@{motor\_controller.c}!mc\_default\_settings@{mc\_default\_settings}}
\index{mc\_default\_settings@{mc\_default\_settings}!motor\_controller.c@{motor\_controller.c}}
\doxysubsubsection{\texorpdfstring{mc\_default\_settings}{mc\_default\_settings}}
{\footnotesize\ttfamily \mbox{\hyperlink{structmotor__controller__settings}{motor\+\_\+controller\+\_\+settings}} mc\+\_\+default\+\_\+settings}

{\bfseries Initial value\+:}
\begin{DoxyCode}{0}
\DoxyCodeLine{= \{}
\DoxyCodeLine{    .can\_id\_tx              = 0x201,}
\DoxyCodeLine{    .can\_id\_rx              = 0x181,}
\DoxyCodeLine{    .mc\_CAN\_timeout         = 2,}
\DoxyCodeLine{    .proportional\_gain      = 10,   }
\DoxyCodeLine{    .integral\_time\_constant = 400,  }
\DoxyCodeLine{    .integral\_memory\_max    = 60    }
\DoxyCodeLine{\}}

\end{DoxyCode}


Definition at line 14 of file motor\+\_\+controller.\+c.



Referenced by M\+C\+\_\+\+Request\+\_\+\+Data(), M\+C\+\_\+\+Set\+\_\+\+Param(), M\+C\+\_\+\+Startup(), Motor\+Controller\+Spin\+Test(), Parse\+\_\+\+Bamocar\+\_\+\+Response(), setup\+Default\+Settings(), and uv\+Reset\+Flash\+To\+Default().

